---
- name: Install dependencies
  apt:
    name: "{{ 'gpg' if ansible_distribution_major_version is version('9','>') else 'gnupg' }}"

- name: Add Docker GPG Key
  apt_key: url=https://download.docker.com/linux/debian/gpg state=present

- name: Ensure Docker APT repo is present
  apt_repository:
    repo: "{{ docker_apt_repo }}"

- name: Gather packages facts
  package_facts:
    manager: apt

- name: Check running instances before install/upgrade
  shell: docker ps -q | sort
  register: before
  changed_when: false
  when: "'docker-ce' in ansible_facts.packages"

- name: Install / update docker
  apt:
    name: "{{ docker_version }}"
    update_cache: true
  notify: restart docker

- name: Check running instances after restart
  shell: docker ps -q | sort
  register: after
  changed_when: false

- name: Compare lists of instances
  fail:
    msg: |
      List of instances is not the same as before restart.
      Before:
      {{ before.stdout }}
      After:
      {{ after.stdout }}
  when:
    - before.stdout is defined
    - before.stdout != after.stdout

- name: Deploy docker daemon template
  template:
    src: etc/docker/daemon.json.j2
    dest: /etc/docker/daemon.json
  notify: restart docker
